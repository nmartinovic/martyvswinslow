<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Marty vs Winslow</title>
  <link rel="preconnect" href="https://cdn.jsdelivr.net" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/modern-css-reset/dist/reset.min.css">
  <style>
    :root { --fg:#0b1221; --muted:#6b7280; --card:#f8fafc; --marty:#184FF8; --winslow:#007F01; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: var(--fg); background:#fff; line-height:1.45; }
    .wrap { max-width:960px; margin:0 auto; padding:16px; }
    header{ margin:4px 0 12px; } h1{ font-size:24px; letter-spacing:.5px; }
    .grid{ display:grid; gap:12px; grid-template-columns:1fr; }
    .card{ background:var(--card); border-radius:16px; padding:14px 16px; box-shadow:0 1px 4px rgba(0,0,0,.06); }
    .kpi{ display:grid; grid-template-columns:1fr; gap:8px; }
    .kpi .big{ font-size:28px; font-weight:700; }
    .sub{ color:var(--muted); font-size:14px; }
    .winner{ font-weight:700; } .winner.marty{ color:var(--marty);} .winner.winslow{ color:var(--winslow);}
    table{ width:100%; border-collapse:collapse; font-size:14px;}
    th,td{ padding:8px; border-bottom:1px solid #e5e7eb; text-align:left;}
    .pill{ padding:3px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb;}
    .pill.marty{ border-color:var(--marty); color:var(--marty);} .pill.winslow{ border-color:var(--winslow); color:var(--winslow);}
    footer{ color:var(--muted); font-size:12px; margin:18px 0 8px; }
    #chart{ width:100%; height:260px; }
    @media (min-width:700px){ .grid{ grid-template-columns:1.1fr 1.2fr;} .kpi{ grid-template-columns:repeat(3,1fr);} h1{ font-size:28px;} #chart{ height:340px;} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Marty vs Winslow</h1>
      <div class="sub">COIN (Coinbase) vs BP market capitalization • Ends May 1, 2030</div>
    </header>

    <section class="grid">
      <div class="card">
        <div class="kpi">
          <div><div class="sub">Days left</div><div class="big" id="daysLeft">—</div></div>
          <div><div class="sub">Currently winning</div><div class="big winner" id="winner">—</div></div>
          <div><div class="sub">% ahead</div><div class="big" id="pctAhead">—</div></div>
        </div>
        <div class="sub" style="margin-top:8px;">% ahead = (leader − loser) / loser</div>
      </div>
      <div class="card"><canvas id="chart" aria-label="% ahead over time" role="img"></canvas></div>
    </section>

    <section class="card" style="margin-top:12px;">
      <div style="display:flex;justify-content:space-between;align-items:baseline;">
        <strong>Historical log</strong><div class="sub" id="lastUpdated">Updated —</div>
      </div>
      <div style="overflow-x:auto;">
        <table id="logTable">
          <thead><tr><th>Date</th><th>BP Market Cap</th><th>COIN Market Cap</th><th>Leader</th><th>% Ahead</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <footer>Maintenance‑free: data updates nightly via GitHub Actions.</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <script>
    const END_DATE = new Date('2030-05-01T23:59:59Z');

    const fmtMoney = n => n>=1e12? (n/1e12).toFixed(2)+'T'
                       : n>=1e9?  (n/1e9 ).toFixed(2)+'B'
                       : n>=1e6?  (n/1e6 ).toFixed(2)+'M' : n.toLocaleString();
    const fmtPct = x => (x*100).toFixed(2) + '%';
    const daysLeft = () => Math.max(0, Math.ceil((END_DATE - new Date()) / 86400000));

    async function run(){
      document.getElementById('daysLeft').textContent = daysLeft();

      const res = await fetch('./data/history.json', { cache: 'no-cache' });
      let rows = await res.json();

      // guard + clean
      rows = (Array.isArray(rows)? rows: []).filter(r =>
        r && r.date && isFinite(+r.bpMarketCap) && isFinite(+r.coinMarketCap)
      );
      if (!rows.length) return;

      // sort ascending by date to ensure proper time series
      rows.sort((a,b)=> new Date(a.date) - new Date(b.date));

      const last = rows[rows.length-1];
      const bp = +last.bpMarketCap, coin = +last.coinMarketCap;

      let leader, ahead;
      if (coin > bp) { leader = 'Marty (COIN)'; ahead = (coin - bp) / bp; }
      else if (bp > coin) { leader = 'Winslow (BP)'; ahead = (bp - coin) / coin; }
      else { leader = 'Tied'; ahead = 0; }

      const w = document.getElementById('winner');
      w.textContent = leader;
      w.className = 'big winner ' + (leader.startsWith('Marty') ? 'marty' : leader.startsWith('Winslow') ? 'winslow' : '');

      document.getElementById('pctAhead').textContent = fmtPct(ahead);
      document.getElementById('lastUpdated').textContent = 'Updated ' + new Date(last.date).toLocaleString();

      // table (newest first)
      const tbody = document.querySelector('#logTable tbody');
      tbody.innerHTML = '';
      rows.slice().reverse().forEach(r=>{
        const leaderRow = r.coinMarketCap > r.bpMarketCap ? 'Marty' : r.coinMarketCap < r.bpMarketCap ? 'Winslow' : 'Tie';
        const pct = leaderRow==='Marty' ? (r.coinMarketCap - r.bpMarketCap)/r.bpMarketCap
                  : leaderRow==='Winslow'? (r.bpMarketCap - r.coinMarketCap)/r.coinMarketCap : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${new Date(r.date).toISOString().slice(0,10)}</td>
                        <td>${fmtMoney(r.bpMarketCap)}</td>
                        <td>${fmtMoney(r.coinMarketCap)}</td>
                        <td>${leaderRow}</td>
                        <td><span class="pill ${leaderRow==='Marty'?'marty':leaderRow==='Winslow'?'winslow':''}">${fmtPct(pct)}</span></td>`;
        tbody.appendChild(tr);
      });

      // build signed % series
      const raw = rows.map(r=>{
        const diff = r.coinMarketCap - r.bpMarketCap;
        const denom = diff >= 0 ? r.bpMarketCap : r.coinMarketCap || 1;
        return { x: new Date(r.date), y: (diff/denom)*100 };
      });

      // insert exact zero-cross points
      const pts = [];
      for (let i=0; i<raw.length-1; i++){
        const p0 = raw[i], p1 = raw[i+1];
        pts.push(p0);
        if (p0.y !== 0 && p0.y * p1.y < 0){
          const t = p0.y / (p0.y - p1.y);
          const xCross = new Date(p0.x.getTime() + t*(p1.x - p0.x));
          pts.push({ x: xCross, y: 0 });
        }
      }
      if (raw.length) pts.push(raw[raw.length-1]);

      const martyData   = pts.map(p => (p.y >= 0 ? p : {x:p.x, y:null}));
      const winslowData = pts.map(p => (p.y <= 0 ? p : {x:p.x, y:null}));

      const maxAbs = Math.max(5, Math.ceil(Math.max(...raw.map(p=>Math.abs(p.y))) * 1.1));

      // dashed zero line
      const zeroLine = {
        id:'zeroLine',
        afterDraw(chart){
          const {ctx, scales:{y}} = chart;
          const y0 = y.getPixelForValue(0);
          ctx.save();
          ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 2; ctx.setLineDash([4,3]);
          ctx.beginPath(); ctx.moveTo(chart.chartArea.left, y0); ctx.lineTo(chart.chartArea.right, y0); ctx.stroke();
          ctx.restore();
        }
      };

      const ctx = document.getElementById('chart');
      new Chart(ctx, {
        type:'line',
        data:{
          datasets:[
            { label:'Marty (+)',   data:martyData,   borderColor:getCSS('--marty'),   backgroundColor:'rgba(24,79,248,0.15)',  borderWidth:2, pointRadius:0, tension:0.25, fill:{target:{value:0}}, spanGaps:false },
            { label:'Winslow (−)', data:winslowData, borderColor:getCSS('--winslow'), backgroundColor:'rgba(0,127,1,0.15)',    borderWidth:2, pointRadius:0, tension:0.25, fill:{target:{value:0}}, spanGaps:false }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false, parsing:false,
          scales:{
            x:{ type:'time', time:{ unit:'day' }, grid:{ display:false } },
            y:{ suggestedMin:-maxAbs, suggestedMax:maxAbs, ticks:{ callback:v=>v+'%' }, grid:{ drawBorder:false } }
          },
          plugins:{ legend:{ display:false }, tooltip:{ callbacks:{ label:c=>c.parsed.y.toFixed(2)+'%' } } }
        },
        plugins:[zeroLine]
      });
    }

    function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }

    run();
  </script>
</body>
</html>
